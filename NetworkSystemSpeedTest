<#
.DESCRIPTION
    This script will create a dummy file, default size of 20mb, and copy to
    and from a target machine in the folder C:\Temp\Speedtest.  
    The Mbps will be determined from the time it takes to perform this operation.

.PARAMETER Path
    Each Path specified must be in UNC format, i.e. \\computername (\\My-Computer)
.PARAMETER Size
    Designate the size of the dummy file in MB
.PARAMETER Verbose
    Will show more details related to the transfer, otherwise basic info is shown when completed.
.INPUTS
    <string> UNC of path
.OUTPUTS
    PSCustomObject
        Server          Name of System
        TimeStamp       Time when script was run
        WriteTime       TimeSpan of how long the write test took back to your PC
        WriteMbps       Mbps of the write test to the target PC
        ReadTime        TimeSpan of how long the read test took back to your PC
        ReadMbps        Mbps of the read test back to your PC
.EXAMPLE
    .\Test-NetworkSpeed.ps1
     Path[0]: \\My-Computer
     Dummy file size will be the default 20mb, Transferred and recieved from NZASL-ABC1234
    
.EXAMPLE
    .\Test-NetworkSpeed.ps1 -Size 100 -Verbose
     Path[0]: \\My-Computer
    Dummy file size will be 100mb, Transferred and recieved back from My-Computer, with verbose logging to see more details
#>
#requires -Version 3.0


[CmdletBinding()]
Param (
    [Parameter(Mandatory,ValueFromPipeline,HelpMessage="Enter \\Systemname (\\My-Computer) to transfer and monitor")]
    [String[]]$Path,
    [ValidateRange(1,1000)]
    [int]$Size = 20
)

Begin {
    Write-Verbose "$(Get-Date): Test-NetworkSpeed Script begins"
    Write-Verbose "$(Get-Date): Create dummy file, Size: $($Size)MB"
    $Source = $PSScriptRoot
    Remove-Item $Source\Test.txt -ErrorAction SilentlyContinue
    Set-Location $Source
    $DummySize = $Size * 1048576
    $CreateMsg = fsutil file createnew test.txt $DummySize

    Try {
        $TotalSize = (Get-ChildItem $Source\Test.txt -ErrorAction Stop).Length
    }
    Catch {
        Write-Warning "Unable to locate dummy file"
        Write-Warning "Create Message: $CreateMsg"
        Write-Warning "Last error: $($Error[0])"
        Exit
    }
    Write-Verbose "$(Get-Date): Source for dummy file: $Source\Test.txt"
    $RunTime = Get-Date
}

Process {
    ForEach ($ServerPath in $Path)
    {   $Server = $ServerPath.Split("\")[2]
        $Target = "$ServerPath\C$\Temp\SpeedTest"
        Write-Verbose "$(Get-Date): Checking speed for $Server..."
        Write-Verbose "$(Get-Date): Destination: $Target"
        
        If (-not (Test-Path $Target))
        {   Try {
                New-Item -Path $Target -ItemType Directory -ErrorAction Stop | Out-Null
            }
            Catch {
                Write-Warning "Problem creating $Target folder because: $($Error[0])"
                [PSCustomObject]@{
                    Server = $Server
                    TimeStamp = $RunTime
                    Status = "$($Error[0])"
                    WriteTime = New-TimeSpan -Days 0
                    WriteMbps = 0
                    ReadTime = New-TimeSpan -Days 0
                    ReadMbps = 0
                }
                Continue
            }
        }
        
        Try {
            Write-Verbose "$(Get-Date): Write Test Running"
            $WriteTest = Measure-Command { 
                Copy-Item $Source\Test.txt $Target -ErrorAction Stop
            }
            
            Write-Verbose "$(Get-Date): Read Test Running"
            $ReadTest = Measure-Command {
                Copy-Item $Target\Test.txt $Source\TestRead.txt -ErrorAction Stop
            }
            $Status = "OK"
            $WriteMbps = [Math]::Round((($TotalSize * 8) / $WriteTest.TotalSeconds) / 1048576,2)
            $ReadMbps = [Math]::Round((($TotalSize * 8) / $ReadTest.TotalSeconds) / 1048576,2)
        }
        Catch {
            Write-Warning "Problem during speed test: $($Error[0])"
            $Status = "$($Error[0])"
            $WriteMbps = $ReadMbps = 0
            $WriteTest = $ReadTest = New-TimeSpan -Days 0
        }
        
        [PSCustomObject]@{
            System = $Server
            TimeStamp = $RunTime
            WriteTime = $WriteTest
            WriteMbps = $WriteMbps
            ReadTime = $ReadTest
            ReadMbps = $ReadMbps
        }
        Remove-Item $Target\Test.txt -ErrorAction SilentlyContinue
        Remove-Item $Source\TestRead.txt -ErrorAction SilentlyContinue
    }
}

End {
    Remove-Item $Source\Test.txt -ErrorAction SilentlyContinue
    Write-Verbose "$(Get-Date): Test-NetworkSpeed completed!"
}
